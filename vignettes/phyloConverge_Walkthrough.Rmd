---
title: "phyloConverge Walkthrough"
author: "Elysia Saputra"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{phyloConverge Walkthrough}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
This walkthrough contains instructions for using _phyloConverge_ to perform convergence analysis on genomic elements. Before following the walkthrough, please make sure that _phyloConverge_ and its dependencies have been successfully installed.

```{r setup}
library(phyloConverge)
library(rphast)
library(RERconverge)
pcpath = find.package('phyloConverge')
```

# Data Input and Formatting

_phyloConverge_ requires the following input data:

* A neutral tree model describing neutral substitution rates. This tree model should be a model file (.mod) that can be estimated from sequence alignment, for example using the _phyloFit_ function in the [PHAST](http://compgen.cshl.edu/phast/phyloFit-tutorial.php) package or [rphast](https://github.com/CshlSiepelLab/RPHAST). Neutral tree models are usually estimated from sites that are expected to evolve neutrally, such as fourfold-degenerate sites. Please refer to tutorials for phyloFit for examples of how to generate neutral tree models.

* The names of the foreground species with the convergent phenotype. Foreground species can be extant (tip) species or ancestral.

* Multiple sequence alignment to be analyzed. Alignment files should either be in the MAF or FASTA format.

# Analysis Walkthrough

## Loading input data

To start the analysis, we need to provide _phyloConverge_ with input data. The **neutral tree model** and the **alignment** can be loaded using the `read.tm` and `read.msa` functions in the _rphast_ package, respectively. The `read.msa` function also accepts alignments in the MAF format. Species names in the tree must match species names in the alignment.

```{r, message=F, warning=F, error=F, results=F, fig.show="hide"}
# Loading neutral tree model
neutral_tree_file = 'eyeStudy.tree.mod'
neutralMod_path = paste0(pcpath, '/data/', neutral_tree_file)
neutralMod = read.tm(neutralMod_path)

# Loading alignment
alnfile = 'CNE031689.fa'
msa = read.msa(alnfile)
```

**Foreground species** names are supplied in the form of a character vector. In the example below, 6 extant species and 1 ancestral species are specified as foregrounds. Currently, _phyloConverge_ is not yet implemented to account for trait loss events, meaning that the daughter species of an ancestral foreground species must also be specified as foregrounds.

```{r, message=F, warning=F, error=F, results=F, fig.show="hide"}
foregrounds = c('nanGal1', 'chrAsi1', 'conCri1', 'hetGla2', 'mm10', 'rn5', 'mm10-rn5')
```

If the phenotype input is in the form of a binary tree, or if the correct nomenclature of the ancestral species is not known, the function `getForegroundsFromTree` can be used to extract the names of the foreground species while ensuring that the ancestral nodes are named correctly.

```{r, message=F, warning=F, error=F, fig.show="hide"}
neutral_tree = getTreeFromEvolMod(neutralMod_path)
foreground_tree = getTreeFromForegrounds(foregrounds, neutral_tree)
foreground_names = getForegroundsFromTree(foreground_tree)
print(foreground_names)

```

## Performing phenotype permulation

A key operation employed by _phyloConverge_ to make predictions of phenotypic association with high specificity is an empirical bias correction strategy called permulation, a portmanteau of 'permutation' and 'simulation'. Permulation is a phylogeny-aware 'trait permutation' strategy in which Brownian motion phylogenetic simulations are performed to generate null phenotypes that match the true observed phenotype in terms of the number of foreground species and the phylogenetic dependence among the foreground species. The null phenotypes are then used to compute empirical p-values that quantify the significance of the convergent rate shifts measured.

Before running `phyloConverge`, we need to generate the **permulated foreground species**, which can be done using the `getPermulatedPhenotypes` function. `getPermulatedPhenotypes` requires the following input arguments:

* `foregrounds`: A character vector containing the tip (and ancestral) foreground species

* `neutraltree`: A tree object containing the tree topology and branch lengths estimated from the neutral tree model, which is contained in the neutral tree model (.mod) file

* `num_perms`: The number of permulations. Note that the number of permulations used will affect the resolution of empirical p-values obtained (e.g., 500 permulations results in p-value resolution of 0.002, etc.). While computation time increases with increasing number of permulations, we recommend 500-1000 permulations.

* `root_species`: The species to root the trees on.

* `output_mod`: set as "names" to output null species character vectors, or "trees" to output binary phenotype trees.

The code below shows an example for generating 10 permulated phenotypes. As we can see, the null phenotypes that are generated also consists of 6 tip species and 1 ancestral species, with a covariance structure that was computed from the observed data.

```{r, message=F, warning=F, error=F, fig.show="hide"}
num_perms = 10
root_species = "mm10"

permulated_foregrounds = getPermulatedPhenotypes(foregrounds, neutral_tree, num_perms, 
						 root_species, output_mod="names")
print(permulated_foregrounds[[1]])
print(permulated_foregrounds[[2]])
print(permulated_foregrounds[[3]])
```

## Computing phenotypic associations with _phyloConverge_

After computing the permulated phenotypes, we can use _phyloConverge_ to compute phenotypic associations of genomic elements. The following sections describes how _phyloConverge_ can be used to compute convergence scores from alignments at different length scales.

### Scoring an entire element

The first function that can be used to compute convergence score with the _phyloConverge_ method is the `phyloConverge` function, which takes the following input arguments:

* `foregrounds`: A character vector containing the tip (and ancestral) foreground species

* `permulated_foregrounds': A list of character vectors containing the null foreground species (i.e., the output of `getPermulatedPhenotypes`)

* `neutralMod`: The neutral tree model

* `maf`: an MSA object containing the sequence alignment

* `refseq`: The reference genome of the alignment

* `feature`: a feature object containing information on chromosomes, coordinates, and names (optional) of the features to be scores (default NULL)

* `alpha`: The target Type I error to control (default 0.05)

* `min.fg`: The minimum number of foreground species required to score for convergence (default 2)

* `method`: Scoring method for _phyloP_ (default "LRT")

* `mode`: Scoring mode for _phyloP_ (default "CONACC")

* `adapt`: A Boolean flag for performing adaptive permulation (default TRUE)

The _phyloConverge_ function can be used to compute the convergence score of an entire input alignment (e.g., if the alignment file is a short alignment of a conserved non-coding element). 


### Scoring subregion(s) of an alignment


### Scanning an element


